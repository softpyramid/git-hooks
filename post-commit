#!/bin/bash

# ==============================================================
# File: post-commit
# Description: Git hook to track developer activity on commit
# Developed by: SOFT PYRAMID LLC
# Created on: 2025-02-11
# ==============================================================

set -e  # Exit script immediately if any command fails
set -u  # Treat unset variables as an error

# Base URL for the Laravel API
BASE_URL="https://mis.softpyramid.com.pk/api"

# Authentication Credentials (Update with actual credentials)
AUTH_USER="enter your mis email here"
AUTH_PASS="enter your mis password here"

# Get developer details
developer_name=$(git config user.name)
developer_email=$(git config user.email)
repo_url=$(git remote get-url origin)
branch_name=$(git rev-parse --abbrev-ref HEAD)
commit_hash=$(git rev-parse HEAD)
commit_url="$repo_url/commit/$commit_hash"
commit_message=$(git log -1 --pretty=%B | jq -R -s .)  # Format commit message as valid JSON string

# Send data to Laravel API with Basic Authentication and output response only
curl -s -X POST "$BASE_URL/log-activity" \
     -u "$AUTH_USER:$AUTH_PASS" \
     -H "Content-Type: application/json" \
     -d "{
         \"developer_name\": \"$developer_name\",
         \"developer_email\": \"$developer_email\",
         \"repo_url\": \"$repo_url\",
         \"branch\": \"$branch_name\",
         \"commit_url\": \"$commit_url\",
         \"commit_message\": $commit_message,
         \"activity_type\": \"push\"
     }"
